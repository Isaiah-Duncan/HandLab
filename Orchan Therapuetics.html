<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HandHero | Therapy Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Fredoka', sans-serif; background-color: #0f172a; color: #f8fafc; overflow: hidden; user-select: none; }
        #app-container { position: relative; width: 100vw; height: 100vh; }
        
        /* Video & Canvas Layers */
        #video-feed { position: absolute; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); opacity: 0.3; z-index: 0; filter: blur(5px); transition: opacity 1s; }
        #output-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; transition: transform 0.1s; }
        #video-feed.active { opacity: 0.9; filter: blur(0px); }
        
        /* Juice Effects */
        .shake { animation: shake 0.3s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }

        /* --- Screens --- */
        #start-screen, #end-screen {
            position: absolute; inset: 0; z-index: 50; display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); transition: opacity 0.5s;
        }
        .hidden { opacity: 0; pointer-events: none; display: none !important; }

        .hero-btn {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            padding: 20px 60px; border-radius: 30px; font-size: 24px; font-weight: 700;
            color: white; box-shadow: 0 0 20px rgba(99, 102, 241, 0.4);
            transform: scale(1); transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: 4px solid rgba(255,255,255,0.1); cursor: pointer;
        }
        .hero-btn:hover { transform: scale(1.05); box-shadow: 0 0 30px rgba(99, 102, 241, 0.6); }
        .hero-btn:active { transform: scale(0.95); }

        /* --- Level Intro Overlay --- */
        #level-intro {
            position: absolute; inset: 0; z-index: 40;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(8px);
            transition: opacity 0.3s;
        }
        .level-card {
            background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%);
            padding: 40px 60px; border-radius: 30px; text-align: center;
            border: 2px solid rgba(255,255,255,0.2);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* --- Minimal HUD --- */
        #game-hud { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 20; }
        
        .top-bar {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 20px; align-items: center;
            background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(12px);
            padding: 10px 30px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1);
            transition: opacity 0.3s;
        }

        .stat-pill { display: flex; flex-direction: column; align-items: center; }
        .stat-label { font-size: 10px; color: #94a3b8; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; }
        .stat-value { font-size: 18px; font-weight: 700; color: white; }

        /* XP Bar at Bottom */
        #xp-container {
            position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
            width: 300px; height: 12px; background: rgba(255,255,255,0.1);
            border-radius: 6px; overflow: hidden; backdrop-filter: blur(4px);
        }
        #xp-fill { height: 100%; background: linear-gradient(90deg, #fbbf24, #f59e0b); width: 0%; transition: width 0.3s; }

        /* Feedback Popups */
        .floating-text {
            position: absolute; font-weight: 800; text-shadow: 0 4px 8px rgba(0,0,0,0.5);
            pointer-events: none; animation: floatUp 1s forwards;
        }
        @keyframes floatUp { 
            0% { transform: translate(-50%, 0) scale(0.5); opacity: 0; }
            20% { transform: translate(-50%, -20px) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -80px) scale(1); opacity: 0; }
        }
    </style>
</head>
<body>

<div id="app-container">
    <video id="video-feed" playsinline muted autoplay></video>
    <canvas id="output-canvas"></canvas>

    <!-- START SCREEN -->
    <div id="start-screen">
        <div class="mb-8 text-center">
            <div class="text-7xl mb-4 animate-bounce">üéÆ</div>
            <h1 class="text-6xl font-bold text-white mb-2 tracking-tight">HandHero</h1>
            <p class="text-xl text-slate-400">Gamified Hand Therapy</p>
        </div>
        <button id="btn-start" class="hero-btn">Start Playing</button>
        <p class="mt-6 text-xs text-slate-500 max-w-xs text-center leading-relaxed">
            Follow the on-screen instructions.<br>
            Move your hand to control the game.
        </p>
    </div>

    <!-- LEVEL INTRO OVERLAY (Replaces blocking UI) -->
    <div id="level-intro" class="hidden">
        <div class="level-card">
            <div class="text-6xl mb-4" id="intro-icon">‚úä</div>
            <h2 class="text-4xl font-bold text-white mb-2" id="intro-title">SQUEEZE</h2>
            <p class="text-xl text-indigo-200 mb-6" id="intro-desc">Close your hand into a fist</p>
            <div class="text-sm font-bold text-white bg-white/20 py-2 px-4 rounded-full inline-block">
                Hold for <span id="intro-time">2</span> Seconds
            </div>
            <div class="mt-8 text-6xl font-bold text-white" id="intro-countdown">3</div>
        </div>
    </div>

    <!-- MINIMAL HUD -->
    <div id="game-hud" class="hidden">
        <div class="top-bar">
            <div class="stat-pill">
                <span class="stat-label">Streak</span>
                <span class="stat-value text-amber-400" id="hud-streak">0</span>
            </div>
            <div class="w-px h-8 bg-white/10 mx-4"></div>
            <div class="stat-pill">
                <span class="stat-label">Level</span>
                <span class="stat-value text-indigo-400" id="hud-level">1</span>
            </div>
            <div class="w-px h-8 bg-white/10 mx-4"></div>
            <button id="btn-quit" class="text-xs font-bold text-slate-400 hover:text-white transition">EXIT</button>
        </div>

        <div id="xp-container">
            <div id="xp-fill"></div>
        </div>
        
        <!-- Center Feedback -->
        <div id="center-feedback" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-center pointer-events-none opacity-0 transition-opacity">
            <div id="hold-timer" class="text-6xl font-bold text-white drop-shadow-lg"></div>
        </div>
    </div>

    <!-- END SCREEN -->
    <div id="end-screen" class="hidden">
        <div class="bg-slate-800 p-10 rounded-3xl text-center border border-slate-700 max-w-md w-full shadow-2xl">
            <div class="text-6xl mb-4">üèÜ</div>
            <h2 class="text-3xl font-bold text-white mb-2">Victory!</h2>
            <p class="text-slate-400 mb-8">You completed today's session.</p>
            
            <div class="flex justify-center gap-8 mb-8">
                <div>
                    <div class="text-4xl font-bold text-emerald-400" id="end-score">0</div>
                    <div class="text-xs uppercase text-slate-500 font-bold mt-1">Total XP</div>
                </div>
                <div>
                    <div class="text-4xl font-bold text-amber-400" id="end-streak">0</div>
                    <div class="text-xs uppercase text-slate-500 font-bold mt-1">Best Streak</div>
                </div>
            </div>

            <button id="btn-restart" class="hero-btn w-full text-lg">Play Again</button>
        </div>
    </div>
</div>

<script>
// ============================================
// GAME CONFIG & EXERCISES
// ============================================
const EXERCISES = [
    { 
        id: 'squeeze', 
        name: 'Squeeze', 
        icon: '‚úä', 
        desc: 'Close your hand tight', 
        duration: 1500, // ms to hold
        // Logic: Check if all fingers curled
        check: (f) => f.fingers.every((ext, i) => i===0 ? true : !ext)
    },
    { 
        id: 'star', 
        name: 'Starfish', 
        icon: 'üñêÔ∏è', 
        desc: 'Open your hand wide', 
        duration: 1500,
        check: (f) => f.fingers.every(ext => ext)
    },
    { 
        id: 'pinch', 
        name: 'Pinch', 
        icon: 'üëå', 
        desc: 'Touch thumb to index', 
        duration: 1000,
        check: (f) => f.pinch
    }
];

const state = {
    screen: 'START', // START, INTRO, PLAY, END
    isModelReady: false,
    handLandmarker: null,
    webcamRunning: false,
    lastVideoTime: -1,
    
    // Game Props
    currentExIdx: 0,
    reps: 0,
    streak: 0,
    score: 0,
    xp: 0,
    level: 1,
    
    // Logic
    holding: false,
    holdStartTime: 0,
    progress: 0,
    cooldown: false,
    
    // Derived
    fingersExtended: [false, false, false, false, false],
    pinch: false
};

// ============================================
// AUDIO SYSTEM (Simple Beeps)
// ============================================
const audio = {
    ctx: null,
    init() { 
        this.ctx = new (window.AudioContext || window.webkitAudioContext)(); 
    },
    playTone(freq, type, duration) {
        if (!this.ctx) this.init();
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.connect(gain);
        gain.connect(this.ctx.destination);
        osc.type = type;
        osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
        gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);
        osc.start();
        osc.stop(this.ctx.currentTime + duration);
    },
    ding() { this.playTone(600, 'sine', 0.5); this.playTone(1200, 'sine', 0.5); },
    charge() { this.playTone(200 + (state.progress * 400), 'triangle', 0.1); }
};

// ============================================
// SETUP & INIT
// ============================================
const el = {
    video: document.getElementById('video-feed'),
    canvas: document.getElementById('output-canvas'),
    start: document.getElementById('start-screen'),
    intro: document.getElementById('level-intro'),
    hud: document.getElementById('game-hud'),
    end: document.getElementById('end-screen'),
    
    // Elements
    introIcon: document.getElementById('intro-icon'),
    introTitle: document.getElementById('intro-title'),
    introDesc: document.getElementById('intro-desc'),
    introTime: document.getElementById('intro-time'),
    introCount: document.getElementById('intro-countdown'),
    
    streak: document.getElementById('hud-streak'),
    level: document.getElementById('hud-level'),
    xpBar: document.getElementById('xp-fill'),
    feedback: document.getElementById('center-feedback'),
    timer: document.getElementById('hold-timer'),
    
    // End
    endScore: document.getElementById('end-score'),
    endStreak: document.getElementById('end-streak')
};
const ctx = el.canvas.getContext('2d');

async function init() {
    resize(); window.addEventListener('resize', resize);
    try {
        const vision = await import("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.js");
        const filesetResolver = await vision.FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm");
        state.handLandmarker = await vision.HandLandmarker.createFromOptions(filesetResolver, {
            baseOptions: { modelAssetPath: `https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task`, delegate: "GPU" },
            runningMode: "VIDEO", numHands: 1
        });
        state.isModelReady = true;
    } catch (e) { alert("AI Load Error"); }
}

document.getElementById('btn-start').addEventListener('click', async () => {
    if (!state.isModelReady) return;
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720 } });
        el.video.srcObject = stream;
        el.video.addEventListener("loadeddata", () => {
            state.webcamRunning = true;
            el.start.classList.add('hidden');
            el.video.classList.add('active');
            loop();
            startLevel(0);
        });
    } catch(e) { alert("Camera Denied"); }
});

document.getElementById('btn-quit').addEventListener('click', () => location.reload());
document.getElementById('btn-restart').addEventListener('click', () => location.reload());

// ============================================
// GAME FLOW
// ============================================

function startLevel(idx) {
    state.screen = 'INTRO';
    state.currentExIdx = idx;
    const ex = EXERCISES[idx];
    
    // Show Intro Card
    el.introIcon.innerText = ex.icon;
    el.introTitle.innerText = ex.name.toUpperCase();
    el.introDesc.innerText = ex.desc;
    el.introTime.innerText = ex.duration / 1000;
    
    el.hud.classList.remove('visible');
    el.intro.classList.remove('hidden');
    
    // Countdown 3..2..1
    let count = 3;
    el.introCount.innerText = count;
    
    const timer = setInterval(() => {
        count--;
        if (count > 0) {
            el.introCount.innerText = count;
        } else {
            clearInterval(timer);
            el.intro.classList.add('hidden');
            el.hud.classList.add('visible');
            state.screen = 'PLAY';
            state.holding = false;
            state.progress = 0;
            state.cooldown = false;
        }
    }, 1000);
}

function updateGame(lm) {
    if (state.screen !== 'PLAY' || state.cooldown) return;
    
    const ex = EXERCISES[state.currentExIdx];
    const isMatch = ex.check({ fingers: state.fingersExtended, pinch: state.pinch }, lm);

    if (isMatch) {
        if (!state.holding) {
            state.holding = true;
            state.holdStartTime = Date.now();
        }
        
        // Progress Logic
        const held = Date.now() - state.holdStartTime;
        state.progress = Math.min(1, held / ex.duration);
        
        // Sound feedback
        if (state.progress < 1 && Math.random() > 0.8) audio.charge();

        if (state.progress >= 1) {
            success(lm);
        }
    } else {
        state.holding = false;
        state.progress = Math.max(0, state.progress - 0.1); // Fast decay
    }
}

function success(lm) {
    state.cooldown = true;
    state.reps++;
    state.streak++;
    state.xp += 10 + (state.streak * 2);
    
    audio.ding();
    spawnText(project(lm[9]).x, project(lm[9]).y, "+XP", "#fbbf24");
    spawnConfetti(project(lm[9]).x, project(lm[9]).y);
    triggerShake();
    
    // UI Update
    el.streak.innerText = state.streak;
    el.xpBar.style.width = `${(state.reps % 5) * 20}%`;
    
    // Level Up Check (Every 5 reps)
    if (state.reps % 5 === 0) {
        state.level++;
        el.level.innerText = state.level; // FIXED: Changed el.statLvl to el.level
        
        // Next Exercise
        const nextIdx = (state.currentExIdx + 1) % EXERCISES.length;
        if (state.reps >= 15) { // Game Over condition for demo
             endGame();
        } else {
             setTimeout(() => startLevel(nextIdx), 1500);
        }
    } else {
        setTimeout(() => state.cooldown = false, 500);
    }
}

function endGame() {
    state.screen = 'END';
    el.hud.classList.remove('visible');
    el.end.classList.remove('hidden');
    el.endScore.innerText = state.xp;
    el.endStreak.innerText = state.streak;
}

// ============================================
// VISION ENGINE
// ============================================

function loop() {
    const now = performance.now();
    if (state.webcamRunning && (!state.lastVideoTime || el.video.currentTime !== state.lastVideoTime)) {
        state.lastVideoTime = el.video.currentTime;
        const results = state.handLandmarker.detectForVideo(el.video, now);
        
        ctx.clearRect(0, 0, el.canvas.width, el.canvas.height);
        
        if (results.landmarks.length > 0) {
            const lm = results.landmarks[0];
            analyzeHand(lm);
            updateGame(lm);
            drawScene(lm);
        }
    }
    
    updateParticles();
    updateTexts();
    requestAnimationFrame(loop);
}

function analyzeHand(lm) {
    // Simple geometry check
    const isExtended = (b, m, t) => {
        const dot = (lm[m].x-lm[b].x)*(lm[t].x-lm[m].x) + (lm[m].y-lm[b].y)*(lm[t].y-lm[m].y);
        return dot > 0.005; // Tweak threshold
    };
    state.fingersExtended = [
        false, // Thumb ignored here
        isExtended(5,6,8), isExtended(9,10,12), isExtended(13,14,16), isExtended(17,18,20)
    ];
    state.pinch = Math.hypot(lm[8].x-lm[4].x, lm[8].y-lm[4].y) < 0.05;
}

// ============================================
// RENDERER
// ============================================

function project(pt) {
    const scale = Math.max(el.canvas.width/1280, el.canvas.height/720);
    const w = 1280*scale, h = 720*scale;
    return {
        x: (el.canvas.width - w)/2 + (1-pt.x)*w,
        y: (el.canvas.height - h)/2 + pt.y*h
    };
}

function drawScene(lm) {
    const ex = EXERCISES[state.currentExIdx];
    const palm = project(lm[9]);

    // 1. Draw Skeleton (Subtle)
    ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.strokeStyle = "rgba(255,255,255,0.15)";
    const connections = [[0,1],[1,2],[2,3],[3,4],[0,5],[5,6],[6,7],[7,8],[0,9],[9,10],[10,11],[11,12],[0,13],[13,14],[14,15],[15,16],[0,17],[17,18],[18,19],[19,20],[5,9],[9,13],[13,17],[0,17]];
    ctx.beginPath();
    connections.forEach(([i,j]) => { const p1=project(lm[i]), p2=project(lm[j]); ctx.moveTo(p1.x,p1.y); ctx.lineTo(p2.x,p2.y); });
    ctx.stroke();

    // 2. Draw Active Joints (Hot/Cold Feedback)
    // We highlight fingertips based on the exercise
    const targets = ex.id === 'pinch' ? [4,8] : [4,8,12,16,20];
    
    targets.forEach(i => {
        const p = project(lm[i]);
        ctx.beginPath(); ctx.arc(p.x, p.y, 8, 0, 2*Math.PI);
        // Color logic: White (Neutral) -> Blue (Target) -> Green (Success)
        if (state.holding) ctx.fillStyle = "#4ade80";
        else ctx.fillStyle = "#60a5fa"; // Target Blue
        ctx.fill();
        
        // Glow
        if (state.holding) {
            ctx.shadowBlur = 15; ctx.shadowColor = "#4ade80"; ctx.stroke(); ctx.shadowBlur = 0;
        }
    });

    // 3. Draw Progress Reticle (Fortnite style)
    if (state.screen === 'PLAY') {
        const radius = 60;
        // Background ring
        ctx.beginPath(); ctx.arc(palm.x, palm.y, radius, 0, 2*Math.PI);
        ctx.lineWidth = 6; ctx.strokeStyle = "rgba(255,255,255,0.1)"; ctx.stroke();
        
        // Fill ring
        if (state.progress > 0) {
            ctx.beginPath();
            ctx.arc(palm.x, palm.y, radius, -Math.PI/2, -Math.PI/2 + (Math.PI*2*state.progress));
            ctx.lineWidth = 8; 
            ctx.strokeStyle = state.progress >= 1 ? "#4ade80" : "#fbbf24";
            ctx.lineCap = "round";
            ctx.stroke();
        }
        
        // Countdown text inside reticle
        if (state.holding && state.progress < 1) {
            const timeLeft = Math.ceil((1 - state.progress) * (ex.duration/1000));
            ctx.fillStyle = "white"; ctx.font = "bold 32px Fredoka";
            ctx.textAlign = "center"; ctx.textBaseline = "middle";
            ctx.fillText(timeLeft, palm.x, palm.y);
        }
        
        // Target Icon nearby
        ctx.font = "24px sans-serif";
        ctx.fillText(ex.icon, palm.x + 50, palm.y - 50);
    }
}

// --- Particles & Text ---
const particles = [];
const texts = [];

function spawnConfetti(x, y) {
    for(let i=0; i<20; i++) {
        particles.push({x, y, vx:(Math.random()-0.5)*15, vy:(Math.random()-0.5)*15, life:1, color:`hsl(${Math.random()*360},90%,60%)`});
    }
}
function updateParticles() {
    for(let i=particles.length-1; i>=0; i--) {
        let p = particles[i]; p.x+=p.vx; p.y+=p.vy; p.vy+=0.5; p.life-=0.03;
        ctx.globalAlpha=p.life; ctx.fillStyle=p.color; ctx.beginPath(); ctx.arc(p.x,p.y,5,0,2*Math.PI); ctx.fill();
        if(p.life<=0) particles.splice(i,1);
    }
    ctx.globalAlpha=1;
}

function spawnText(x, y, txt, col) { texts.push({x, y, txt, col, life:1, vy:-2}); }
function updateTexts() {
    for(let i=texts.length-1; i>=0; i--) {
        let t = texts[i]; t.y+=t.vy; t.life-=0.02;
        ctx.globalAlpha=t.life; ctx.fillStyle=t.col; ctx.font="bold 30px Fredoka"; ctx.textAlign="center"; ctx.fillText(t.txt, t.x, t.y);
        if(t.life<=0) texts.splice(i,1);
    }
    ctx.globalAlpha=1;
}

function triggerShake() {
    el.canvas.classList.add('shake');
    setTimeout(() => el.canvas.classList.remove('shake'), 300);
}

function resize() { el.canvas.width = window.innerWidth; el.canvas.height = window.innerHeight; }
window.addEventListener('resize', resize);

// Init
init();

</script>
</body>
</html>